<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partitioned survival models • hesim</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Partitioned survival models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hesim</a>
        <span class="label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased package">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/psm.html">Partitioned survival models</a>
    </li>
    <li>
      <a href="../articles/icea.html">Individualized cost-effectiveness analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/InnovationValueInitiative/hesim">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Partitioned survival models</h1>
            
            <h4 class="date">2018-08-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/InnovationValueInitiative/hesim/blob/master/vignettes/psm.Rmd"><code>vignettes/psm.Rmd</code></a></small>
      <div class="hidden name"><code>psm.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>An N-state partitioned survival model (PSM) simulates the probability that a patient is in each of N distinct health states at a given point of time when treated by a particular therapy. State membership is estimated from a set of non-mutually exclusive survival curves; for an N-state model, N-1 survival curves are required.</p>
<p>The cumulative survival function, <span class="math inline">\(S(t)_n\)</span>, represents the probability that a patient survives to health state <span class="math inline">\(n\)</span> or to a lower indexed state beyond time <span class="math inline">\(t\)</span>. The probability that a patient is in health state 1 is always just <span class="math inline">\(S(t)_1\)</span>. State membership in health states <span class="math inline">\(2,\ldots, n-1\)</span> is calculated as <span class="math inline">\(S(t)_{n} - S(t)_{n-1}\)</span>. Finally, the probability of being in the final health state <span class="math inline">\(n\)</span> (i.e., the dead state) is <span class="math inline">\(1-S(t)_{n-1}\)</span>, or one minus the overall survival curve.</p>
<p>In <code>hesim</code>, an N-state PSM consists of three types of separate statistical models: a set of N-1 survival models, a model of the utility values to assign to each health state, and a set of models for costs to assign to each health state. Multiple cost models can be used to categorize costs into different categories (e.g., costs of medical care, drug costs). All models can either be fit using R or constructed with external data.</p>
<p>Separate survival curves are predicted for each treatment strategy and patient. That is, the probability of survival given a survival model with <span class="math inline">\(L\)</span> parameters, <span class="math inline">\(\alpha_1, \ldots, \alpha_L\)</span>, for patient <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> with treatment strategy <span class="math inline">\(k\)</span> is given by,</p>
<p><span class="math display">\[
\begin{aligned}
S_{ik}(t) &amp;= 1 - F(y_{ik} | \alpha_1(x_{1, ik}), \ldots, \alpha_L(x_{L, ik})),\\
\alpha_l &amp;=  g^{-1}(x_{l,ik}^T \beta_l),
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(F(\cdot)\)</span> is the cumulative distribution function for a non-negative continuous variable, <span class="math inline">\(y\)</span>, reflecting time to an event, <span class="math inline">\(g^{-1}(\cdot)\)</span> is an inverse transformation function, <span class="math inline">\(\beta_l\)</span>, is a vector of coefficients and <span class="math inline">\(x_l\)</span> is an input vector of covariates. Likewise, we predict utility and cost values, <span class="math inline">\(v\)</span>, in health state <span class="math inline">\(h\)</span> for patient <span class="math inline">\(i\)</span> with treatment strategy <span class="math inline">\(k\)</span>,</p>
<p><span class="math display">\[
\begin{aligned}
\hat{v} &amp;= E(v_{hik} | \alpha_1(x_{1, ikl}), \ldots, \alpha_L(x_{L, hik})),\\
\alpha_l &amp;=  g^{-1}(x_{l, hik}^T \beta_l).
\end{aligned}
\]</span> Quality-adjusted life-years (QALYs) and total costs associated with a given health state for a given treatment strategy and patient are calculated by integrating the “weighted” probability of survival, where weights are a function of the discount factor and predicted state values. Mathematically, QALYs and total costs for the <span class="math inline">\(m\)</span>th cost category are calculated as,</p>
<p><span class="math display">\[
\begin{aligned}
\rm{QALYs}_{hik} &amp;= \int_{0}^{T} q_{hik} e^{-rt} p_{hik}(t)dt, \\
\rm{Costs}_{m,hik} &amp;= \int_{0}^{T} c_{m,hik} e^{-rt} p_{hik}(t)dt,
\end{aligned}
\]</span> where <span class="math inline">\(t\)</span> denotes time (typically a year), <span class="math inline">\(q\)</span> is a quality-of-life weight, <span class="math inline">\(c\)</span> represents (assmuming that time is measured in years) annualized costs, <span class="math inline">\(r\)</span> is the discount rate, and <span class="math inline">\(p(t)\)</span> is the probability of being in a given health state at a given time, and QALYs and costs are calculated over <span class="math inline">\(T\)</span> time periods.</p>
</div>
<div id="an-example-4-state-psm" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example-4-state-psm" class="anchor"></a>An example 4-state PSM</h2>
<p>To illustrate a partitioned survival analysis, consider the evaluation of a two-line sequential treatment strategy in oncology using a 4-state PSM. The 4 health states might be:</p>
<ul>
<li>Progression free on first line treatment</li>
<li>Progression free on second line treatment</li>
<li>Progressed on second line treatment</li>
<li>Death</li>
</ul>
<p>Below we conduct an example analysis using this setup.</p>
</div>
<div id="parameter-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#parameter-estimation" class="anchor"></a>Parameter estimation</h2>
<p>The first step in any health-economic simulation is to estimate the model parameters. Since analyses in <code>hesim</code> are, by default, based on sampled values of the parameters in order to facilitate probabilistic sensitivity analysis (PSA), it is a good idea to determine the number of sampled parameter sets that are desired.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_samples &lt;-<span class="st"> </span><span class="dv">100</span></code></pre></div>
<div id="survival-models" class="section level3">
<h3 class="hasAnchor">
<a href="#survival-models" class="anchor"></a>Survival models</h3>
<p>The parameters of the survival models would typically be estimated in one of two ways. First, if access to patient level data from a clinical trial were available, survival models would be fit using available R packages. Second, a formal evidence synthesis—such as a network meta-analysis—might be conducted. Here, we provide an example of an analysis with trial level data.</p>
<p>We consider a dataset with three survival endpoints with endpoint 1 denoting the lowest indexed state, endpoint 2 the next indexed state, and endpoint 3 representing overall survival. In our example, endpoint 1 represents progression on 1st line treatment, endpoint 2 represents progression on 2nd line treatment, and endpoint 3 represents death.</p>
<p>Survival models in <code>hesim</code> can be fit using either <code>flexsurvreg</code> or <code>flexsurvspline</code> from the <code>flexsurv</code> package. <code>hesim</code> currently supports parametric (exponential, Weibull, Gompertz, gamma, log-logistic, lognormal, and generalized gamma) and spline survival models. In this example, we fit a Weibull model to each of the three survival endpoints. We then create an object of class <code>partsurvfit</code>, which stores the fitted survival models along with the data using for the fitting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"hesim"</span>)
<span class="kw">library</span>(<span class="st">"flexsurv"</span>)
surv_dataset &lt;-<span class="st"> </span>psm4_exdata<span class="op">$</span>survival
fit1 &lt;-<span class="st"> </span>flexsurv<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/flexsurv/topics/flexsurvreg">flexsurvreg</a></span>(<span class="kw">Surv</span>(endpoint1_time, endpoint1_status) <span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>female <span class="op">+</span><span class="st"> </span>
<span class="st">                                   </span><span class="kw">factor</span>(strategy_id),
                              <span class="dt">data =</span> surv_dataset,
                              <span class="dt">dist =</span> <span class="st">"weibull"</span>)
fit2 &lt;-<span class="st"> </span>flexsurv<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/flexsurv/topics/flexsurvreg">flexsurvreg</a></span>(<span class="kw">Surv</span>(endpoint2_time, endpoint2_status) <span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>female <span class="op">+</span>
<span class="st">                                   </span><span class="kw">factor</span>(strategy_id),
                              <span class="dt">data =</span> surv_dataset,
                              <span class="dt">dist =</span> <span class="st">"weibull"</span>)
fit3 &lt;-<span class="st"> </span>flexsurv<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/flexsurv/topics/flexsurvreg">flexsurvreg</a></span>(<span class="kw">Surv</span>(endpoint3_time, endpoint3_status) <span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>female <span class="op">+</span>
<span class="st">                                   </span><span class="kw">factor</span>(strategy_id),
                              <span class="dt">data =</span> surv_dataset,
                              <span class="dt">dist =</span> <span class="st">"weibull"</span>)
psfit_wei &lt;-<span class="st"> </span><span class="kw"><a href="../reference/partsurvfit.html">partsurvfit</a></span>(<span class="kw"><a href="../reference/flexsurvreg_list.html">flexsurvreg_list</a></span>(fit1, fit2, fit3), 
                         <span class="dt">data =</span> surv_dataset)</code></pre></div>
</div>
<div id="cost-models" class="section level3">
<h3 class="hasAnchor">
<a href="#cost-models" class="anchor"></a>Cost models</h3>
<p>Currently, <code>hesim</code> supports parameterizing a cost or utility model using linear models. For instance, we can fit a model for medical costs as a function of the three non-death health states using the <code>lm()</code> function in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">medcosts_fit &lt;-<span class="st"> </span>stats<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(costs <span class="op">~</span><span class="st"> </span>female <span class="op">+</span><span class="st"> </span>state_name, <span class="dt">data =</span> psm4_exdata<span class="op">$</span>costs<span class="op">$</span>medical)</code></pre></div>
<p>We can also use a linear model to predict drug costs that only vary by treatment strategy. In this case, a linear model parameter object (i.e., an object of class <code>params_lm</code>) can be created directly with the <code><a href="../reference/params_lm.html">params_lm()</a></code> function. The linear model has no intercept (meaning that we specify the costs for strategy 1, strategy 2, and strategy 3) and cost values are constant across samples in the PSA.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">drugcosts_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(psm4_exdata<span class="op">$</span>costs<span class="op">$</span>drugs<span class="op">$</span>costs, n_samples), 
                         <span class="dt">nrow =</span> n_samples, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
drugcosts_params &lt;-<span class="st"> </span><span class="kw"><a href="../reference/params_lm.html">params_lm</a></span>(<span class="dt">coefs  =</span> drugcosts_mat)</code></pre></div>
</div>
<div id="utility-model" class="section level3">
<h3 class="hasAnchor">
<a href="#utility-model" class="anchor"></a>Utility model</h3>
<p>We can create a utility model in similar fashion to the drug cost model. Suppose that a study from the literature suggests that utility ranges from .8 to .9 in state 1, .7 to .8 in state 2, and .6 to .7 in state 3. Then we might sample utility in each state using a uniform distribution (although the beta distribution would likely be more appropriate for sampling utility scores).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">utility1 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_samples, .<span class="dv">8</span>, .<span class="dv">9</span>)
utility2 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_samples, .<span class="dv">7</span>, .<span class="dv">8</span>)
utility3 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_samples, .<span class="dv">6</span>, .<span class="dv">7</span>)
utility_params &lt;-<span class="st"> </span><span class="kw"><a href="../reference/params_lm.html">params_lm</a></span>(<span class="dt">coefs  =</span> <span class="kw">cbind</span>(utility1, utility2, utility3))</code></pre></div>
</div>
</div>
<div id="forming-a-model-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#forming-a-model-structure" class="anchor"></a>Forming a model structure</h2>
<p>A PSM in <code>hesim</code> is an <a href="https://cran.r-project.org/web/packages/R6/">R6</a> object of class <code>Psm</code> and comprises of three separate submodels: (1) a set of survival models for generating survival curves (of class <code>PsmCurves</code>), (2) a utility model (of class <code>StateVals</code>), and (3) a set of cost models for each cost component (a list of <code>StateVals</code> objects).</p>
<div id="simulation-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulation-data" class="anchor"></a>Simulation data</h3>
<p>The input data required to simulate partitioned survival models in <code>hesim</code> can be set up in 3 steps as described in our <a href="intro.html">introduction to hesim</a>. First, the data can be set up as a collection of data frames or data tables. A 4-state PSM consists of three types of data tables: a table describing treatment strategies, the patient population of interest, and four health states (death and three non-death states). In this example, we model three treatment strategies and three distinct patients that differ in age and gender. Relevant tables are combined using <code><a href="../reference/hesim_data.html">hesim_data()</a></code>, which creates a general object of class <code>hesim_data</code> for storing data tables for simulation modeling in <code>hesim</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"data.table"</span>)
<span class="kw">set.seed</span>(<span class="dv">101</span>)
dt_strategies &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(<span class="dt">strategy_id =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
dt_patients &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(<span class="dt">patient_id =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">3</span>),
                          <span class="dt">age =</span> <span class="kw">c</span>(<span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">60</span>),
                          <span class="dt">female =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>))
dt_states &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">state_id =</span>  <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">3</span>),
                        <span class="dt">state_name =</span> <span class="kw">c</span>(<span class="st">"Progression free (1st line)"</span>,
                                       <span class="st">"Progression free (2nd line)"</span>,
                                       <span class="st">"Progressed (2nd line)"</span>),
                        <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
hesim_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/hesim_data.html">hesim_data</a></span>(<span class="dt">strategies =</span> dt_strategies,
                        <span class="dt">patients =</span> dt_patients,
                        <span class="dt">states =</span> dt_states)
<span class="kw">print</span>(hesim_dat)</code></pre></div>
<pre><code>## $strategies
##    strategy_id
## 1:           1
## 2:           2
## 3:           3
## 
## $patients
##    patient_id age female
## 1:          1  45      0
## 2:          2  50      0
## 3:          3  60      1
## 
## $states
##   state_id                  state_name
## 1        1 Progression free (1st line)
## 2        2 Progression free (2nd line)
## 3        3       Progressed (2nd line)
## 
## attr(,"class")
## [1] "hesim_data"</code></pre>
<p>Second, we can use <code><a href="../reference/expand_hesim_data.html">expand_hesim_data()</a></code> to “expand” the <code>hesim_data</code> object into single “long” dataset of class “expanded_hesim_data” suitable for predictive modeling. To model survival curves, we require a dataset in which each observation is a unique treatment strategy and patient, while each observation in the utility and cost models must be a unique treatment strategy, patient, and health state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">surv_edata &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_hesim_data.html">expand_hesim_data</a></span>(hesim_dat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"strategies"</span>, <span class="st">"patients"</span>))
statevals_edata &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_hesim_data.html">expand_hesim_data</a></span>(hesim_dat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"strategies"</span>, <span class="st">"patients"</span>, <span class="st">"states"</span>))</code></pre></div>
<p>Third, for a given statistical model, we extract the relevant covariates and id variables from an “expanded_hesim_data” object to construct input matrices and row indices for prediction. We illustrate this third step when creating the survival, utility, and cost models below.</p>
</div>
<div id="survival-models-1" class="section level3">
<h3 class="hasAnchor">
<a href="#survival-models-1" class="anchor"></a>Survival models</h3>
<p>Since we fit our survival models using <code>flexsurvreg</code>, we can create a <code>PsmCurves</code> object using <code><a href="../reference/create_PsmCurves.html">create_PsmCurves()</a></code>, which generates both the input data and samples of the model parameters needed for prediction.</p>
<p>The model parameters can be sampled in one of two ways. First, the parameters of each survival model can be sampled separately using a multivariate normal distribution. However, this option does not preserve the correlation in the survival endpoints. By default, <code><a href="../reference/create_PsmCurves.html">create_PsmCurves()</a></code> consequently samples the parameters via bootstrapping, whereby the survival models are refit repeatedly to resamples of the data element in a <code>partsurvfit</code> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">psm_curves &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_PsmCurves.html">create_PsmCurves</a></span>(psfit_wei, <span class="dt">data =</span> surv_edata, <span class="dt">n =</span> n_samples,
                               <span class="dt">bootstrap =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="creating-cost-and-utility-models" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-cost-and-utility-models" class="anchor"></a>Creating cost and utility models</h3>
<p>We fit a linear model to medical costs, so we can use the <code><a href="../reference/create_StateVals.html">create_StateVals()</a></code> to instantiate a <code>StateVals</code> object for medical costs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">psm_medcosts &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_StateVals.html">create_StateVals</a></span>(medcosts_fit, <span class="dt">data =</span> statevals_edata, 
                                 <span class="dt">n =</span> n_samples)</code></pre></div>
<p>Drug costs were not fit with a model in R, so we cannot instantiate a model for drug costs using <code><a href="../reference/create_StateVals.html">create_StateVals()</a></code>. Instead, we create the model from our <code>params_lm</code> class object and input data (of class <code>input_data</code>). Since we don’t have fitted R model, we can use a <code>formula_list</code> object to specify the explanatory variables in the model. That is, we use <code><a href="../reference/formula_list.html">formula_list()</a></code> to obtain the variables (<code>strategy_id</code>) in <code>statevals_edata</code> that are needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">input_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_input_data.html">create_input_data</a></span>(<span class="kw"><a href="../reference/formula_list.html">formula_list</a></span>(<span class="dt">mu =</span> <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(state_id)), 
                               <span class="dt">data =</span> statevals_edata)
psm_drugcosts &lt;-<span class="st"> </span>StateVals<span class="op">$</span><span class="kw">new</span>(<span class="dt">data =</span> input_dat, <span class="dt">params =</span> drugcosts_params)</code></pre></div>
<p>We can instantiate a utility model in the same manner.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">input_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_input_data.html">create_input_data</a></span>(<span class="kw"><a href="../reference/formula_list.html">formula_list</a></span>(<span class="dt">mu =</span> <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(state_id)), 
                               <span class="dt">data =</span> statevals_edata)
psm_utility &lt;-<span class="st"> </span>StateVals<span class="op">$</span><span class="kw">new</span>(<span class="dt">data =</span> input_dat, <span class="dt">params =</span> utility_params)</code></pre></div>
</div>
<div id="combining-the-statistical-models" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-the-statistical-models" class="anchor"></a>Combining the statistical models</h3>
<p>The PSM model is instantiated using <code>$new()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">psm &lt;-<span class="st"> </span>Psm<span class="op">$</span><span class="kw">new</span>(<span class="dt">survival_models =</span> psm_curves,
               <span class="dt">utility_model =</span> psm_utility,
               <span class="dt">cost_models =</span> <span class="kw">list</span>(<span class="dt">medical =</span> psm_medcosts, 
                                  <span class="dt">drug =</span> psm_drugcosts))</code></pre></div>
</div>
</div>
<div id="simulating-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-outcomes" class="anchor"></a>Simulating outcomes</h2>
<div id="simulating-survival-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-survival-curves" class="anchor"></a>Simulating survival curves</h3>
<p>Survival curves are predicted by treatment strategy and patient with the function <code>$sim_survival()</code>. The predicted curves are returned as a tidy <code>data.table</code> to facilitate plotting and stored as a field in the class named <code>survival_</code>. Below we plot the mean survival curve for patient 2 with treatment strategy 3.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simulate</span>
times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">by =</span> .<span class="dv">1</span>)
psm<span class="op">$</span><span class="kw">sim_survival</span>(<span class="dt">t =</span> times)

<span class="co"># Plot</span>
<span class="kw">library</span>(<span class="st">"ggplot2"</span>)
surv_means &lt;-<span class="st"> </span>psm<span class="op">$</span>survival_[, .(<span class="dt">mean_surv =</span> <span class="kw">mean</span>(survival)),
                                      by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"curve"</span>, <span class="st">"strategy_id"</span>, <span class="st">"patient_id"</span>, <span class="st">"t"</span>)]
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme_get">theme_set</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>())
p_data &lt;-<span class="st"> </span>surv_means[strategy_id <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">&amp;</span><span class="st"> </span>patient_id <span class="op">==</span><span class="st"> </span><span class="dv">2</span>]
p_data[, curve <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(curve)]
p_data[, mean_surv_min <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(times)), p_data[curve <span class="op">!=</span><span class="dv">3</span>, mean_surv])]
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(p_data, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> t, <span class="dt">y =</span> mean_surv, <span class="dt">fill =</span> curve)) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">col =</span> curve)) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_ribbon">geom_ribbon</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">ymin =</span> mean_surv_min, <span class="dt">ymax =</span> mean_surv), <span class="dt">alpha =</span> .<span class="dv">65</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"Years"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"Proportion surviving"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_hue">scale_color_discrete</a></span>(<span class="dt">name =</span> <span class="st">"Survival curve"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/guides">guides</a></span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="psm_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="simulating-health-state-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-health-state-probabilities" class="anchor"></a>Simulating health state probabilities</h3>
<p>After simulating survival, we can calculate the probability of being in each of the four health states using <code>$sim_stateprobs()</code>. At a given point in time, the probability of being in state 1 is the survival probability from the first survival curve, the probability of being in state 2 is the difference in survival probabilities between the 2nd and 1st curves, the probability of being in state 3 is the difference in survival probabilities between the 3rd and 2nd curves, and the probability of death is 1 minus the survival probability from curve 3. We plot these state probabilities for the first patient with the 30th randomly sampled parameter set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simulate</span>
psm<span class="op">$</span><span class="kw">sim_stateprobs</span>()

<span class="co"># Plot</span>
stateprobs &lt;-<span class="st"> </span>psm<span class="op">$</span>stateprobs_[sample <span class="op">==</span><span class="st"> </span><span class="dv">30</span> <span class="op">&amp;</span><span class="st"> </span>patient_id <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]
stateprobs[, state <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(state_id, 
                             <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(state_id)))]
stateprobs[, strategy <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(strategy_id, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"Strategy 1"</span>, <span class="st">"Strategy 2"</span>, 
                                                        <span class="st">"Strategy 3"</span>))]
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(stateprobs[strategy_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)],
            <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> t, <span class="dt">y =</span> prob, <span class="dt">fill =</span> state, <span class="dt">group =</span> state)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_ribbon">geom_area</a></span>(<span class="dt">alpha =</span> .<span class="dv">65</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>strategy) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"Years"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"Proportion in state"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_manual">scale_fill_manual</a></span>(<span class="dt">name =</span> <span class="st">"Health state"</span>,
                    <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"gray92"</span>, <span class="st">"green4"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span>),
                    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"Death"</span>, 
                               <span class="kw">rev</span>(hesim_dat<span class="op">$</span>states<span class="op">$</span>state_name))) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/guides">guides</a></span>(<span class="dt">fill =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/guide_legend">guide_legend</a></span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="psm_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div id="simulating-costs-and-qalys" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-costs-and-qalys" class="anchor"></a>Simulating costs and QALYs</h3>
<p>Finally, we can simulate discounted costs and QALYs by numerically integrating the “weighted” probabilities in <code>$stateprobs_</code> as described above. Costs and QALYs are produced for each treatment strategy, patient, health state, and sampled parameter set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Costs</span>
psm<span class="op">$</span><span class="kw">sim_costs</span>(<span class="dt">dr =</span> .<span class="dv">03</span>)
<span class="kw">head</span>(psm<span class="op">$</span>costs_)</code></pre></div>
<pre><code>##    state_id sample strategy_id patient_id   dr category    costs
## 1:        1      1           1          1 0.03  medical 17805.61
## 2:        1      1           1          2 0.03  medical 16982.68
## 3:        1      1           1          3 0.03  medical 16840.39
## 4:        1      1           2          1 0.03  medical 18638.75
## 5:        1      1           2          2 0.03  medical 17777.79
## 6:        1      1           2          3 0.03  medical 17629.48</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># QALYs</span>
psm<span class="op">$</span><span class="kw">sim_qalys</span>(<span class="dt">dr =</span> .<span class="dv">03</span>)
<span class="kw">head</span>(psm<span class="op">$</span>qalys_)</code></pre></div>
<pre><code>##    state_id sample strategy_id patient_id   dr category     qalys
## 1:        1      1           1          1 0.03    qalys 0.5885128
## 2:        1      1           1          2 0.03    qalys 0.5613132
## 3:        1      1           1          3 0.03    qalys 0.5178926
## 4:        1      1           2          1 0.03    qalys 0.6160499
## 5:        1      1           2          2 0.03    qalys 0.5875933
## 6:        1      1           2          3 0.03    qalys 0.5421594</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#an-example-4-state-psm">An example 4-state PSM</a></li>
      <li><a href="#parameter-estimation">Parameter estimation</a></li>
      <li><a href="#forming-a-model-structure">Forming a model structure</a></li>
      <li><a href="#simulating-outcomes">Simulating outcomes</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
